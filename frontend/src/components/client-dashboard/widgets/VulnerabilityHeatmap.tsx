import { useMemo, useState } from 'react';
import EmptyState from '../ui/EmptyState';

export type HeatmapCell = {
  id: string;
  endpoint: string; // path or url
  severity: 'Critical' | 'High' | 'Medium' | 'Low' | 'Info';
  type: string;
  owasp?: string;
  details?: string;
};

export type VulnerabilityHeatmapProps = {
  title?: string;
  items: HeatmapCell[];
};

const severityTone: Record<HeatmapCell['severity'], string> = {
  Critical: 'bg-red-600/40 border-red-500/30',
  High: 'bg-orange-500/35 border-orange-500/30',
  Medium: 'bg-yellow-500/30 border-yellow-500/30',
  Low: 'bg-green-600/25 border-green-500/30',
  Info: 'bg-green-600/15 border-green-500/20',
};

export default function VulnerabilityHeatmap({ title = 'Vulnerability heatmap', items }: VulnerabilityHeatmapProps) {
  const [typeFilter, setTypeFilter] = useState('All');
  const [selectedId, setSelectedId] = useState<string | null>(null);

  const types = useMemo(() => {
    const set = new Set(items.map((i) => i.type));
    return ['All', ...Array.from(set).sort()];
  }, [items]);

  const filtered = useMemo(() => (typeFilter === 'All' ? items : items.filter((i) => i.type === typeFilter)), [items, typeFilter]);

  const selected = useMemo(() => filtered.find((x) => x.id === selectedId) || null, [filtered, selectedId]);

  const legend = (
    <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
      <span>Red → Green</span>
      <span className="inline-flex items-center gap-1">
        <span className="h-2.5 w-2.5 rounded bg-red-600/40 border border-red-500/30" /> Critical
      </span>
      <span className="inline-flex items-center gap-1">
        <span className="h-2.5 w-2.5 rounded bg-orange-500/35 border border-orange-500/30" /> High
      </span>
      <span className="inline-flex items-center gap-1">
        <span className="h-2.5 w-2.5 rounded bg-yellow-500/30 border border-yellow-500/30" /> Medium
      </span>
      <span className="inline-flex items-center gap-1">
        <span className="h-2.5 w-2.5 rounded bg-green-600/25 border border-green-500/30" /> Low
      </span>
    </div>
  );

  return (
    <div className="apple-card">
      <div className="flex items-start justify-between gap-4">
        <div>
          <div className="text-sm font-semibold text-gray-900 dark:text-gray-100">{title}</div>
          <div className="mt-1 text-xs text-gray-500 dark:text-gray-400">Endpoint grid by severity. Click a cell to view details.</div>
        </div>
        <div className="min-w-[180px]">
          <div className="text-xs text-gray-500 dark:text-gray-400">Filter by type</div>
          <select
            value={typeFilter}
            onChange={(e) => {
              setTypeFilter(e.target.value);
              setSelectedId(null);
            }}
            className="mt-1 w-full rounded-xl border border-gray-200 dark:border-white/10 bg-white dark:bg-black px-3 py-2 text-sm text-gray-900 dark:text-gray-100"
          >
            {types.map((t) => (
              <option key={t} value={t}>
                {t}
              </option>
            ))}
          </select>
        </div>
      </div>

      <div className="mt-3">{legend}</div>

      {filtered.length === 0 ? (
        <div className="mt-4">
          <EmptyState title="No endpoints" description="No endpoints match your current filter." />
        </div>
      ) : (
        <div className="mt-4 grid grid-cols-2 gap-2 sm:grid-cols-4 lg:grid-cols-6">
          {filtered.map((i) => {
            const tone = severityTone[i.severity];
            const active = selectedId === i.id;
            return (
              <button
                key={i.id}
                type="button"
                onClick={() => setSelectedId(i.id)}
                className={
                  'relative rounded-xl border p-3 text-left transition-colors ' +
                  tone +
                  ' ' +
                  (active ? 'ring-2 ring-blue-500/30' : 'hover:bg-white/40 dark:hover:bg-white/5')
                }
                title={`${i.endpoint} • ${i.severity} • ${i.type}`}
              >
                <div className="text-[11px] font-semibold text-gray-900 dark:text-gray-100 truncate">{i.endpoint}</div>
                <div className="mt-1 text-[10px] text-gray-700/80 dark:text-gray-200/70 truncate">{i.severity}</div>
                <div className="mt-1 text-[10px] text-gray-700/80 dark:text-gray-200/70 truncate">{i.type}</div>
              </button>
            );
          })}
        </div>
      )}

      <div className="mt-4 rounded-xl border border-gray-200 dark:border-white/10 bg-white dark:bg-black p-4">
        <div className="text-sm font-medium text-gray-900 dark:text-gray-100">Details</div>
        {selected ? (
          <div className="mt-2">
            <div className="flex items-start justify-between gap-3">
              <div className="min-w-0">
                <div className="text-sm font-semibold text-gray-900 dark:text-gray-100 truncate">{selected.endpoint}</div>
                <div className="mt-1 text-xs text-gray-500 dark:text-gray-400 truncate">
                  {selected.severity} · {selected.type}
                  {selected.owasp ? ` · ${selected.owasp}` : ''}
                </div>
              </div>
              <span className="text-xs text-gray-500 dark:text-gray-400">Click another cell to switch</span>
            </div>
            {selected.details ? <div className="mt-3 text-sm text-gray-700 dark:text-gray-200">{selected.details}</div> : null}
          </div>
        ) : (
          <div className="mt-2 text-sm text-gray-500 dark:text-gray-400">Select an endpoint cell to view details.</div>
        )}
      </div>
    </div>
  );
}
